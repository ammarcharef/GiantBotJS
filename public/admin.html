<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Master Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { overflow: auto; background: #000; padding: 20px; font-family: 'Tajawal', sans-serif; }
        .glass { background: #111; border: 1px solid #333; margin-bottom: 20px; padding: 15px; border-radius: 10px; }
        input, button { border-radius: 5px; padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .btn-act { background: #10b981; color: white; border: none; cursor: pointer; }
        .btn-danger { background: #ef4444; color: white; border: none; cursor: pointer; }
        .grid-menu { display: flex; gap: 15px; margin-bottom: 20px; }
        .grid-menu div { background: #222; padding: 10px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid #444; }
        .gold { color: #f59e0b; font-weight: bold; font-size: 1.2rem; }
        .red { color: #ef4444; font-weight: bold; font-size: 1.2rem; }
        
        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆØ± */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #333; color: #ccc; }
        th { color: #f59e0b; background: #1a1a1a; }
        tr:hover { background: #222; }
        .ref-tag { background: #334155; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #fff; }
    </style>
</head>
<body>
    <div style="max-width:1000px; margin:auto;">
        <div class="glass" style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:white; margin:0;">ğŸ‘‘ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <div style="display:flex; gap:10px;">
                <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" style="width:150px;">
                <button class="btn-act" style="width:auto;" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>

        <div id="panel" class="hidden">
            <div class="grid-menu">
                <div>ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ <br><span id="s-usr" class="gold">0</span></div>
                <div>ğŸ’° Ù…Ø¹Ù„Ù‚ <br><span id="s-wth" class="red">0</span></div>
                <div>ğŸ”— Ø¥Ø­Ø§Ù„Ø§Øª Ù†Ø´Ø·Ø© <br><span id="s-refs" class="gold">0</span></div>
            </div>

            <div class="glass">
                <h3 style="color:#f59e0b; margin-top:0;">ğŸ‘¤ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <input type="text" id="search-user" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¢ÙŠØ¯ÙŠ..." onkeyup="filterUsers()">
                <div style="max-height: 400px; overflow-y: auto;">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)</th>
                                <th>ØªÙ…Øª Ø¯Ø¹ÙˆØªÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>ØªØ­ÙƒÙ…</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="glass">
                    <h3>â• Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <input id="t-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                    <input id="t-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
                    <div style="display:flex; gap:5px;">
                        <input id="t-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <input id="t-sec" type="number" placeholder="Ø«ÙˆØ§Ù†ÙŠ">
                    </div>
                    <button class="btn-act" onclick="addTask()">Ù†Ø´Ø±</button>
                </div>
                <div class="glass">
                    <h3>ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ†</h3>
                    <div style="display:flex; gap:5px;">
                        <input id="c-code" placeholder="Ø§Ù„ÙƒÙˆØ¯">
                        <input id="c-amnt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                    </div>
                    <input id="c-max" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª">
                    <button class="btn-act" onclick="addCoupon()">Ø¥Ù†Ø´Ø§Ø¡</button>
                </div>
            </div>

            <div class="glass">
                <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
                <div id="w-list"></div>
            </div>
        </div>
    </div>

    <script>
        let pass = "";
        let allUsers = [];

        async function auth() {
            pass = document.getElementById('pass').value;
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch('/api/admin', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({password: pass, action: 'data'}) 
                });
                const data = await res.json();
                
                if(data.error) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø© âŒ");
                
                document.getElementById('panel').classList.remove('hidden');
                document.getElementById('s-usr').innerText = data.stats.users;
                document.getElementById('s-wth').innerText = data.stats.withdraws;
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
                let totalRefs = 0;
                data.usersList.forEach(u => { if(u.referrer) totalRefs++; });
                document.getElementById('s-refs').innerText = totalRefs;

                allUsers = data.usersList || []; 
                renderUsers(allUsers);

                document.getElementById('w-list').innerHTML = data.withdrawals.length ? data.withdrawals.map(w => `
                    <div style="border-bottom:1px solid #333; padding:10px 0; display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem; color:#fff;">${w.amount} DZD</div>
                            <div style="color:#aaa; font-size:0.9rem;">${w.userName} (${w.userId})</div>
                            <div style="color:#f59e0b; font-size:0.8rem;">${w.method}: ${w.account}</div>
                        </div>
                        <div>
                            <button class="action-btn btn-act" onclick="proc('${w._id}', 'paid')">Ø¯ÙØ¹</button>
                            <button class="action-btn btn-danger" onclick="proc('${w._id}', 'rejected')">Ø±ÙØ¶</button>
                        </div>
                    </div>
                `).join('') : '<p style="color:#777; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';

            } catch(e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); }
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>
                        <span style="color:white; font-weight:bold;">${u.fullName || u.name}</span><br>
                        <span class="ref-tag">${u.id}</span>
                    </td>
                    <td>
                        ${u.referrer ? `<span style="color:#f59e0b;">Ù…ÙØ­Ø§Ù„ Ù…Ù†: ${u.referrer}</span>` : '<span style="color:#555;">Ù…Ø¨Ø§Ø´Ø±</span>'}
                    </td>
                    <td style="color:#10b981; font-weight:bold;">${u.balance.toFixed(2)}</td>
                    <td>${u.isBanned ? '<span style="color:red">â›”</span>' : '<span style="color:green">âœ…</span>'}</td>
                    <td>
                        <button class="action-btn btn-danger" onclick="manageUser('${u.id}', 'ban')">${u.isBanned ? 'ÙÙƒ' : 'Ø­Ø¸Ø±'}</button>
                        <button class="action-btn" style="background:#555; color:white;" onclick="manageUser('${u.id}', 'delete')">X</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const term = document.getElementById('search-user').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.name && u.name.toLowerCase().includes(term)) || 
                (u.id && u.id.toString().includes(term)) ||
                (u.referrer && u.referrer.toString().includes(term)) // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø­ÙŠÙ„ Ø£ÙŠØ¶Ø§Ù‹
            );
            renderUsers(filtered);
        }

        async function manageUser(id, type) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ")) return;
            await fetch('/api/admin', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: pass, action: 'manage_user', payload: {id, type}}) });
            loadData();
        }

        async function addTask() {
            const payload = {
                title: document.getElementById('t-title').value,
                url: document.getElementById('t-url').value,
                fullPrice: document.getElementById('t-price').value,
                seconds: document.getElementById('t-sec').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_task', payload}) });
            alert("ØªÙ…");
        }

        async function addCoupon() {
            const payload = {
                code: document.getElementById('c-code').value,
                amount: document.getElementById('c-amnt').value,
                maxUses: document.getElementById('c-max').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_coupon', payload}) });
            alert("ØªÙ…");
        }

        async function proc(id, status) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ØŸ")) return;
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'process_withdraw', payload:{id, status}}) });
            loadData();
        }
    </script>
</body>
</html>