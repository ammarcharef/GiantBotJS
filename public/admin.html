<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Master Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { overflow: auto; background: #000; padding: 20px; font-family: 'Tajawal', sans-serif; }
        .glass { background: #111; border: 1px solid #333; margin-bottom: 20px; padding: 15px; border-radius: 10px; }
        input, button { border-radius: 5px; padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .btn-act { background: #10b981; color: white; border: none; cursor: pointer; }
        .btn-danger { background: #ef4444; color: white; border: none; cursor: pointer; }
        .grid-menu { display: flex; gap: 15px; margin-bottom: 20px; }
        .grid-menu div { background: #222; padding: 10px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid #444; }
        .gold { color: #f59e0b; font-weight: bold; font-size: 1.2rem; }
        .red { color: #ef4444; font-weight: bold; font-size: 1.2rem; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #333; color: #ccc; }
        th { color: #f59e0b; }
        .action-btn { padding: 5px 10px; font-size: 0.8rem; width: auto; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <div style="max-width:900px; margin:auto;">
        <div class="glass" style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:white; margin:0;">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            <div style="display:flex; gap:10px;">
                <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" style="width:150px;">
                <button class="btn-act" style="width:auto;" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>

        <div id="panel" class="hidden">
            <div class="grid-menu">
                <div>ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ <br><span id="s-usr" class="gold">0</span></div>
                <div>ğŸ’° Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© <br><span id="s-wth" class="red">0</span></div>
            </div>

            <div class="glass">
                <h3 style="color:#f59e0b; margin-top:0;">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <input type="text" id="search-user" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¢ÙŠØ¯ÙŠ..." onkeyup="filterUsers()">
                <div style="max-height: 300px; overflow-y: auto;">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="glass">
                    <h3 style="margin-top:0;">â• Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <input id="t-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                    <input id="t-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
                    <input id="t-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒØ§Ù…Ù„">
                    <input id="t-sec" type="number" placeholder="Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ">
                    <button class="btn-act" onclick="addTask()">Ù†Ø´Ø± ğŸš€</button>
                </div>

                <div class="glass">
                    <h3 style="margin-top:0;">ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
                    <input id="c-code" placeholder="Ø§Ù„ÙƒÙˆØ¯">
                    <input id="c-amnt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                    <input id="c-max" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">
                    <button class="btn-act" onclick="addCoupon()">Ø¥Ù†Ø´Ø§Ø¡ âœ¨</button>
                </div>
            </div>

            <div class="glass">
                <h3 style="margin-top:0;">ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
                <div id="w-list"></div>
            </div>
        </div>
    </div>

    <script>
        let pass = "";
        let allUsers = [];

        async function auth() {
            pass = document.getElementById('pass').value;
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch('/api/admin', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({password: pass, action: 'data'}) 
                });
                const data = await res.json();
                
                if(data.error) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø© âŒ");
                
                document.getElementById('panel').classList.remove('hidden');
                
                // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                document.getElementById('s-usr').innerText = data.stats.users;
                document.getElementById('s-wth').innerText = data.stats.withdraws;
                
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø­ÙØ¸Ù‡Ù… Ù„Ù„Ù…ØªØºÙŠØ± Ù„Ù„Ø¨Ø­Ø«)
                allUsers = data.usersList || []; 
                renderUsers(allUsers);

                // Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
                document.getElementById('w-list').innerHTML = data.withdrawals.length ? data.withdrawals.map(w => `
                    <div style="border-bottom:1px solid #333; padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem; color:#fff;">${w.amount} DZD</div>
                            <div style="color:#aaa; font-size:0.9rem;">${w.userName} | ${w.method}</div>
                            <div style="color:#f59e0b; font-size:0.9rem;">${w.account}</div>
                        </div>
                        <div>
                            <button class="action-btn btn-act" onclick="proc('${w._id}', 'paid')">Ø¯ÙØ¹</button>
                            <button class="action-btn btn-danger" onclick="proc('${w._id}', 'rejected')">Ø±ÙØ¶</button>
                        </div>
                    </div>
                `).join('') : '<p style="color:#777; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>';

            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.fullName || u.name} <br> <small style="color:#555">${u.id}</small></td>
                    <td style="color:#10b981; font-weight:bold;">${u.balance.toFixed(2)}</td>
                    <td>${u.isBanned ? '<span style="color:red">Ù…Ø­Ø¸ÙˆØ±</span>' : '<span style="color:green">Ù†Ø´Ø·</span>'}</td>
                    <td>
                        <button class="action-btn btn-danger" onclick="manageUser('${u.id}', 'ban')">${u.isBanned ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}</button>
                        <button class="action-btn" style="background:#555; color:white;" onclick="manageUser('${u.id}', 'delete')">Ø­Ø°Ù ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const term = document.getElementById('search-user').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.name && u.name.toLowerCase().includes(term)) || 
                (u.id && u.id.toString().includes(term))
            );
            renderUsers(filtered);
        }

        async function manageUser(id, actionType) {
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${actionType === 'delete' ? 'Ø­Ø°Ù' : 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø©'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;
            
            await fetch('/api/admin', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({password: pass, action: 'manage_user', payload: {id, type: actionType}}) 
            });
            alert("ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
            loadData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        }

        async function addTask() {
            const payload = {
                title: document.getElementById('t-title').value,
                url: document.getElementById('t-url').value,
                fullPrice: document.getElementById('t-price').value,
                seconds: document.getElementById('t-sec').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_task', payload}) });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
        }

        async function addCoupon() {
            const payload = {
                code: document.getElementById('c-code').value,
                amount: document.getElementById('c-amnt').value,
                maxUses: document.getElementById('c-max').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_coupon', payload}) });
            alert("ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡");
        }

        async function proc(id, status) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'process_withdraw', payload:{id, status}}) });
            loadData();
        }
    </script>
</body>
</html>