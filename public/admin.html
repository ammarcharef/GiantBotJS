<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-card { background: #1e293b; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-num { font-size: 1.5rem; color: #fbbf24; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 8px; border-bottom: 1px solid #333; text-align: right; }
        th { color: #fbbf24; }
        .tab-btn { background: #333; border: none; padding: 10px 20px; color: white; cursor: pointer; }
        .active-tab { background: #fbbf24; color: black; font-weight: bold; }
        .section { display: none; }
    </style>
</head>
<body>
    <div style="max-width: 800px; margin: auto;">
        <div class="glass">
            <h2>ğŸ‘®â€â™‚ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
            <input type="password" id="admin-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:10px;">
            <button class="btn" onclick="loadData()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div class="admin-grid">
            <div class="stat-card">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†<div class="stat-num" id="s-users">0</div></div>
            <div class="stat-card">Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©<div class="stat-num" id="s-money">0</div></div>
            <div class="stat-card">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨<div class="stat-num" id="s-withdraw">0</div></div>
        </div>

        <br>
        <div>
            <button class="tab-btn active-tab" onclick="showTab('users')">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
            <button class="tab-btn" onclick="showTab('tasks')">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
            <button class="tab-btn" onclick="showTab('withdraws')">Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</button>
        </div>

        <div id="tab-users" class="section glass" style="display:block;">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <table id="users-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-tasks" class="section glass">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø®Ø§Ø±Ø¬ÙŠ/Ø¯Ø§Ø®Ù„ÙŠ</h3>
            <input id="t-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
            <input id="t-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø· (Smartlink Ø£Ùˆ Ù‚Ù†Ø§Ø©)">
            <input id="t-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒØ§Ù…Ù„ (DZD)">
            <input id="t-sec" type="number" placeholder="Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ">
            <button class="btn btn-green" onclick="addTask()">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <hr>
            <table id="tasks-table"><thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-withdraws" class="section glass">
            <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
            <table id="withdraw-table"><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹</th><th>Ù‚Ø±Ø§Ø±</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <script>
        let password = "";
        
        async function loadData() {
            password = document.getElementById('admin-pass').value;
            const res = await fetch('/api/admin/data', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password})
            });
            const data = await res.json();
            if(data.error) { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"); return; }

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('s-users').innerText = data.stats.totalUsers;
            document.getElementById('s-money').innerText = data.stats.totalBalance.toFixed(2);
            document.getElementById('s-withdraw').innerText = data.stats.pendingWithdrawals;

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            fillTable('users-table', data.users, (u) => `
                <td>${u.fullName || u.name} <br> <small>${u.paymentAccount || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</small></td>
                <td>${u.balance.toFixed(2)}</td>
                <td>${u.isBanned ? 'Ù…Ø­Ø¸ÙˆØ±' : `<button onclick="action('ban_user', '${u.id}')" style="color:red">Ø­Ø¸Ø±</button>`}</td>
            `);

            fillTable('tasks-table', data.tasks, (t) => `
                <td>${t.title} <br> <a href="${t.url}" target="_blank">Ø±Ø§Ø¨Ø·</a></td>
                <td>${t.fullPrice}</td>
                <td><button onclick="action('delete_task', '${t._id}')">âŒ</button></td>
            `);
            
            // Ù‡Ù†Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            fillTable('withdraw-table', data.withdrawals, (w) => `
                <td>${w.userId}</td>
                <td style="color:#fbbf24">${w.amount}</td>
                <td>${w.method} <br> <b>${w.account}</b></td>
                <td>
                    <button onclick="action('approve_withdraw', '${w._id}')">âœ…</button>
                    <button onclick="action('reject_withdraw', '${w._id}')">âŒ</button>
                </td>
            `);
        }

        function fillTable(id, list, rowFn) {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = "";
            list.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = rowFn(item);
                tbody.appendChild(tr);
            });
        }

        async function action(type, id) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
            await fetch('/api/admin/action', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password, type, id})
            });
            loadData(); // ØªØ­Ø¯ÙŠØ«
        }

        async function addTask() {
            const payload = {
                title: document.getElementById('t-title').value,
                url: document.getElementById('t-url').value,
                fullPrice: document.getElementById('t-price').value,
                seconds: document.getElementById('t-sec').value
            };
            await fetch('/api/admin/action', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password, type: 'add_task', payload})
            });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
            loadData();
        }

        function showTab(name) {
            document.querySelectorAll('.section').forEach(d => d.style.display = 'none');
            document.getElementById('tab-' + name).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            event.target.classList.add('active-tab');
        }
    </script>
</body>
</html>
