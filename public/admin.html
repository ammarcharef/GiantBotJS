<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin App</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2331/2331716.png">

    <link rel="stylesheet" href="style.css">
    <style>
        /* --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª --- */
        body { 
            background: #000; padding: 15px; font-family: 'Tajawal', sans-serif; 
            margin: 0; overflow-x: hidden; padding-bottom: 50px;
        }
        
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ --- */
        .glass { 
            background: #111; border: 1px solid #333; margin-bottom: 15px; 
            padding: 15px; border-radius: 12px; 
        }

        /* --- Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        h2, h3 { margin: 0; color: #fff; }
        .gold { color: #f59e0b; }
        .red { color: #ef4444; }

        /* --- Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        input, button { 
            border-radius: 8px; padding: 12px; margin: 5px 0; 
            width: 100%; box-sizing: border-box; font-size: 1rem;
        }
        input { background: #222; border: 1px solid #444; color: white; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ù…Ù„ÙˆÙ†Ø© */
        .btn-act { background: #10b981; color: white; border: none; font-weight: bold; }
        .btn-primary { background: #f59e0b; color: black; border: none; font-weight: bold; }
        .btn-danger { background: #ef4444; color: white; border: none; font-weight: bold; }

        /* --- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª --- */
        .grid-stats { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; 
        }
        .stat-box { 
            background: #222; padding: 10px; border-radius: 8px; 
            text-align: center; border: 1px solid #444; 
        }
        .stat-box span { font-size: 1.2rem; font-weight: bold; display: block; margin-top: 5px; }

        /* --- Ø´Ø¨ÙƒØ© Ø§Ù„Ø§Ø¯Ø®Ø§Ù„ (Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØ§Ù„Ù‡Ø§ØªÙ) --- */
        .grid-form { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
        }

        /* --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ (ÙŠØªØ­ÙˆÙ„ Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ) --- */
        .table-container { max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { color: #f59e0b; text-align: right; padding: 10px; border-bottom: 1px solid #444; background: #1a1a1a; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #333; color: #ccc; vertical-align: middle; }

        .action-btn { 
            padding: 6px 12px; font-size: 0.8rem; width: auto; 
            display: inline-block; margin-left: 5px; 
        }

        /* --- ğŸ“± ØªØ®ØµÙŠØµ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Responsive Media Query) --- */
        @media (max-width: 768px) {
            /* Ø¬Ø¹Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù…ÙˆØ¯ÙŠÙ† Ø¨Ø¯Ù„ 3 */
            .grid-stats { grid-template-columns: 1fr 1fr; }
            
            /* Ø¬Ø¹Ù„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ (ÙÙˆÙ‚ Ø¨Ø¹Ø¶) */
            .grid-form { grid-template-columns: 1fr; }

            /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª (Cards) */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr { 
                background: #1a1a1a; border: 1px solid #333; 
                margin-bottom: 10px; border-radius: 10px; padding: 10px;
            }
            
            td { 
                border: none; position: relative; padding-left: 0; 
                display: flex; justify-content: space-between; align-items: center;
                border-bottom: 1px solid #333;
            }
            td:last-child { border-bottom: none; flex-direction: column; gap: 5px; align-items: stretch; }
            
            /* Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù„Ø®Ø§Ù†Ø§Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            td:before { 
                content: attr(data-label); 
                font-weight: bold; color: #666; font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>

    <div id="login-screen" style="max-width:400px; margin:50px auto; text-align:center;">
        <i class="fas fa-user-secret" style="font-size:4rem; color:#f59e0b; margin-bottom:20px;"></i>
        <h2 style="margin-bottom:20px;">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</h2>
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©">
        <button class="btn-primary" onclick="auth()">ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ”“</button>
    </div>

    <div id="panel" class="hidden" style="max-width:1000px; margin:auto;">
        
        <div class="header-bar">
            <h2>ğŸ‘‘ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±</h2>
            <button class="btn-danger" style="width:auto;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="grid-stats">
            <div class="stat-box">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† <span id="s-usr" class="gold">0</span></div>
            <div class="stat-box">ğŸ’¸ Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‚ <span id="s-wth" class="red">0</span></div>
            <div class="stat-box">ğŸ”— Ø¥Ø­Ø§Ù„Ø§Øª <span id="s-refs" class="gold">0</span></div>
        </div>

        <div class="glass">
            <h3 class="gold">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <input type="text" id="search-user" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterUsers()">
            <div class="table-container">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ØªØ­ÙƒÙ…</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="glass">
            <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</h3>
            <input id="t-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
            <input id="t-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
            <div class="grid-form">
                <input id="t-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <input id="t-sec" type="number" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø«ÙˆØ§Ù†ÙŠ)">
            </div>
            <button class="btn-act" onclick="addTask()">Ù†Ø´Ø± Ø§Ù„Ù…Ù‡Ù…Ø© ğŸš€</button>
        </div>

        <div class="glass">
            <h3>ğŸŸï¸ Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¨ÙˆÙ†</h3>
            <div class="grid-form">
                <input id="c-code" placeholder="Ø§Ù„ÙƒÙˆØ¯">
                <input id="c-amnt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            </div>
            <input id="c-max" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª">
            <button class="btn-primary" onclick="addCoupon()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† âœ¨</button>
        </div>

        <div class="glass">
            <h3 class="gold">ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
            <div id="w-list"></div>
        </div>
    </div>

    <script>
        let pass = "";
        let allUsers = [];

        async function auth() {
            pass = document.getElementById('pass').value;
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch('/api/admin', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({password: pass, action: 'data'}) 
                });
                const data = await res.json();
                
                if(data.error) return alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('panel').classList.remove('hidden');
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                document.getElementById('s-usr').innerText = data.stats.users;
                document.getElementById('s-wth').innerText = data.stats.withdraws;
                
                let totalRefs = 0;
                data.usersList.forEach(u => { if(u.referrer) totalRefs++; });
                document.getElementById('s-refs').innerText = totalRefs;

                allUsers = data.usersList || []; 
                renderUsers(allUsers);

                // Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Ø¯ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
                document.getElementById('w-list').innerHTML = data.withdrawals.length ? data.withdrawals.map(w => `
                    <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #444;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="font-weight:bold; font-size:1.1rem; color:#fff;">${w.amount} DZD</span>
                            <span style="color:#aaa; font-size:0.8rem;">${new Date(w.date).toLocaleDateString()}</span>
                        </div>
                        <div style="color:#ccc; margin-bottom:10px;">
                            ğŸ‘¤ ${w.userName} <br>
                            ğŸ’³ ${w.method}: <span class="gold">${w.account}</span>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <button class="btn-act" onclick="proc('${w._id}', 'paid')">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
                            <button class="btn-danger" onclick="proc('${w._id}', 'rejected')">Ø±ÙØ¶</button>
                        </div>
                    </div>
                `).join('') : '<p style="color:#777; text-align:center;">Ù†Ø¸ÙŠÙ! Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>';

            } catch(e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); }
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td data-label="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                        <div>
                            <span style="font-weight:bold; color:white;">${u.fullName || u.name}</span>
                            <br><small style="color:#666;">${u.id}</small>
                        </div>
                    </td>
                    <td data-label="Ø§Ù„Ø±ØµÙŠØ¯" style="color:#10b981; font-weight:bold;">${u.balance.toFixed(2)}</td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">${u.isBanned ? '<span style="color:red">â›” Ù…Ø­Ø¸ÙˆØ±</span>' : '<span style="color:green">âœ… Ù†Ø´Ø·</span>'}</td>
                    <td data-label="ØªØ­ÙƒÙ…">
                        <button class="action-btn btn-danger" style="width:100%" onclick="manageUser('${u.id}', 'ban')">${u.isBanned ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}</button>
                        <button class="action-btn" style="width:100%; background:#444; color:white; margin-top:5px;" onclick="manageUser('${u.id}', 'delete')">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const term = document.getElementById('search-user').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.name && u.name.toLowerCase().includes(term)) || 
                (u.id && u.id.toString().includes(term))
            );
            renderUsers(filtered);
        }

        async function manageUser(id, type) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
            await fetch('/api/admin', { 
                method: 'POST', headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({password: pass, action: 'manage_user', payload: {id, type}}) 
            });
            loadData();
        }

        async function addTask() {
            const payload = {
                title: document.getElementById('t-title').value,
                url: document.getElementById('t-url').value,
                fullPrice: document.getElementById('t-price').value,
                seconds: document.getElementById('t-sec').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_task', payload}) });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± âœ…");
        }

        async function addCoupon() {
            const payload = {
                code: document.getElementById('c-code').value,
                amount: document.getElementById('c-amnt').value,
                maxUses: document.getElementById('c-max').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_coupon', payload}) });
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† âœ…");
        }

        async function proc(id, status) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'process_withdraw', payload:{id, status}}) });
            loadData();
        }
    </script>
</body>
</html>