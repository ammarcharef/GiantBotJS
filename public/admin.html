<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { overflow: auto !important; height: auto !important; background: #000; padding: 15px; font-family: 'Tajawal'; }
        .glass { background: #111; border: 1px solid #333; margin-bottom: 20px; padding: 15px; border-radius: 10px; }
        input, button { border-radius: 5px; padding: 10px; width: 100%; margin: 5px 0; box-sizing: border-box; }
        .btn-act { background: #10b981; color: white; border: none; cursor: pointer; }
        .btn-danger { background: #ef4444; color: white; border: none; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #333; color: #ccc; }
        th { color: #f59e0b; }
    </style>
</head>
<body>
    <div style="max-width:800px; margin:auto;">
        <div class="glass" style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:white; margin:0;">ğŸ‘‘ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <div style="display:flex; gap:5px;">
                <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" style="width:120px;">
                <button class="btn-act" style="width:auto;" onclick="loadData()">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>

        <div id="panel" class="hidden">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <div class="glass" style="text-align:center;">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ <br><span id="s-usr" class="gold">0</span></div>
                <div class="glass" style="text-align:center;">ğŸ’¸ Ù…Ø¹Ù„Ù‚ <br><span id="s-wth" class="red">0</span></div>
            </div>

            <div class="glass">
                <h3>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <div style="max-height:300px; overflow-y:auto;">
                    <table id="users-table">
                        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="glass">
                <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</h3>
                <input id="t-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                <input id="t-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
                <div style="display:flex; gap:5px;">
                    <input id="t-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                    <input id="t-sec" type="number" placeholder="Ø«ÙˆØ§Ù†ÙŠ">
                </div>
                <button class="btn-act" onclick="addTask()">Ù†Ø´Ø±</button>
                
                <h4 style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
                <div id="tasks-list-admin" style="max-height:200px; overflow-y:auto;"></div>
            </div>

            <div class="glass">
                <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
                <div id="w-list"></div>
            </div>
        </div>
    </div>

    <script>
        let pass = "";
        async function loadData() {
            pass = document.getElementById('pass').value;
            const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'data'}) });
            const data = await res.json();
            if(data.error) return alert("Ø®Ø·Ø£");
            document.getElementById('panel').classList.remove('hidden');
            
            document.getElementById('s-usr').innerText = data.stats.users;
            document.getElementById('s-wth').innerText = data.stats.withdraws;

            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            document.querySelector('#users-table tbody').innerHTML = data.usersList.map(u => `
                <tr>
                    <td>${u.fullName}<br><small>${u.id}</small></td>
                    <td class="gold">${u.balance.toFixed(2)}</td>
                    <td>${u.isBanned ? 'â›”' : 'âœ…'}</td>
                    <td>
                        <button class="btn-danger" style="padding:5px;" onclick="manage('${u.id}', 'ban')">${u.isBanned?'ÙÙƒ':'Ø­Ø¸Ø±'}</button>
                        <button style="padding:5px; background:#555; color:white; border:none; border-radius:5px;" onclick="manage('${u.id}', 'delete')">X</button>
                    </td>
                </tr>
            `).join('');

            // Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            document.getElementById('tasks-list-admin').innerHTML = data.tasksList.map(t => `
                <div style="border-bottom:1px solid #333; padding:5px; display:flex; justify-content:space-between; align-items:center;">
                    <div>${t.title} <small class="gold">(${t.totalClicks} Ù†Ù‚Ø±Ø©)</small></div>
                    <button class="btn-danger" style="width:auto; padding:5px 10px;" onclick="delTask('${t._id}')">Ø­Ø°Ù</button>
                </div>
            `).join('');

            // Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
            document.getElementById('w-list').innerHTML = data.withdrawals.map(w => `
                <div style="border-bottom:1px solid #333; padding:10px 0;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${w.amount} DZD</b>
                        <span style="color:#aaa">${w.userName}</span>
                    </div>
                    <div style="font-size:0.9rem; color:#f59e0b;">${w.method}: ${w.account}</div>
                    <div style="margin-top:5px; display:flex; gap:10px;">
                        <button class="btn-act" onclick="proc('${w._id}', 'paid')">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
                        <button class="btn-danger" onclick="proc('${w._id}', 'rejected')">Ø±ÙØ¶</button>
                    </div>
                </div>
            `).join('');
        }

        async function addTask() {
            const payload = {
                title: document.getElementById('t-title').value,
                url: document.getElementById('t-url').value,
                fullPrice: document.getElementById('t-price').value,
                seconds: document.getElementById('t-sec').value
            };
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_task', payload}) });
            alert("ØªÙ…"); loadData();
        }

        async function delTask(id) {
            if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'delete_task', payload:{id}}) });
            loadData();
        }

        async function manage(id, type) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ØŸ")) return;
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'manage_user', payload:{id, type}}) });
            loadData();
        }

        async function proc(id, status) {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ØŸ")) return;
            await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'process_withdraw', payload:{id, status}}) });
            loadData();
        }
    </script>
</body>
</html>