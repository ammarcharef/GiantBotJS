<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { overflow-y: auto !important; height: auto !important; background: #000; padding: 15px; }
        .glass { background: #111; border: 1px solid #333; margin-bottom: 20px; padding: 15px; border-radius: 10px; }
        input, button { border-radius: 5px; padding: 10px; width: 100%; margin: 5px 0; box-sizing: border-box; }
        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #222; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #444; }
        .action-btn { padding: 5px 10px; width: auto; display: inline-block; margin-left: 5px; }
    </style>
</head>
<body>
    <div style="max-width:900px; margin:auto;">
        <div class="glass" style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:white; margin:0;">ğŸ‘‘ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±</h2>
            <div><input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" style="width:120px;"><button class="btn-act" style="width:auto;" onclick="auth()">Ø¯Ø®ÙˆÙ„</button></div>
        </div>

        <div id="panel" class="hidden">
            <div class="grid-stats">
                <div class="stat-box">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ <br><span id="s-usr" class="gold">0</span></div>
                <div class="stat-box">ğŸ’¸ Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‚ <br><span id="s-wth" class="red">0</span></div>
                <div class="stat-box">ğŸ”— Ø¥Ø­Ø§Ù„Ø§Øª <span id="s-refs" class="gold">0</span></div>
            </div>

            <div class="glass">
                <h3>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <input type="text" id="search-user" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterUsers()">
                <div style="max-height: 300px; overflow-y: auto;"><table id="users-table"><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ­ÙƒÙ…</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div class="glass">
                <h3>â• Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <input id="t-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"><input id="t-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
                <div style="display:flex; gap:5px;"><input id="t-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±"><input id="t-sec" type="number" placeholder="Ø«ÙˆØ§Ù†ÙŠ"></div>
                <button class="btn-act" onclick="addTask()">Ù†Ø´Ø±</button>
            </div>

            <div class="glass">
                <h3>ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ†</h3>
                <div style="display:flex; gap:5px;"><input id="c-code" placeholder="Ø§Ù„ÙƒÙˆØ¯"><input id="c-amnt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
                <input id="c-max" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
                <button class="btn-act" onclick="addCoupon()">Ø¥Ù†Ø´Ø§Ø¡</button>
            </div>

            <div class="glass"><h3>ğŸ’¸ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</h3><div id="w-list"></div></div>
        </div>
    </div>

    <script>
        let pass = "", allUsers = [];
        async function auth() { pass = document.getElementById('pass').value; loadData(); }
        async function loadData() {
            const res = await fetch('/api/admin', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: pass, action: 'data'}) });
            const data = await res.json();
            if(data.error) return alert("âŒ");
            document.getElementById('panel').classList.remove('hidden');
            document.getElementById('s-usr').innerText = data.stats.users;
            document.getElementById('s-wth').innerText = data.stats.withdraws;
            let totalRefs = 0; if(data.usersList) data.usersList.forEach(u => { if(u.referrer) totalRefs++; }); document.getElementById('s-refs').innerText = totalRefs;
            allUsers = data.usersList || []; renderUsers(allUsers);
            document.getElementById('w-list').innerHTML = data.withdrawals.map(w => `<div style="border-bottom:1px solid #333; padding:10px 0; display:flex; justify-content:space-between;"><div><b>${w.amount} DZD</b><br><small style="color:#aaa">${w.userName}</small></div><div><button class="action-btn btn-act" onclick="proc('${w._id}','paid')">Ø¯ÙØ¹</button><button class="action-btn btn-danger" onclick="proc('${w._id}','rejected')">Ø±ÙØ¶</button></div></div>`).join('');
        }
        function renderUsers(users) {
            document.querySelector('#users-table tbody').innerHTML = users.map(u => `<tr><td><b>${u.fullName||u.name}</b><br><small>${u.id}</small></td><td class="gold">${u.balance.toFixed(2)}</td><td>${u.isBanned?'â›”':'âœ…'}</td><td><button class="action-btn btn-danger" onclick="manage('${u.id}','ban')">${u.isBanned?'ÙÙƒ':'Ø­Ø¸Ø±'}</button><button class="action-btn" style="background:#555;color:#fff" onclick="manage('${u.id}','delete')">X</button></td></tr>`).join('');
        }
        function filterUsers() { const term = document.getElementById('search-user').value.toLowerCase(); renderUsers(allUsers.filter(u => (u.name && u.name.toLowerCase().includes(term)) || (u.id && u.id.toString().includes(term)))); }
        async function manage(id, type) { if(!confirm("ØªØ£ÙƒÙŠØ¯ØŸ")) return; await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'manage_user', payload:{id, type}}) }); loadData(); }
        async function addTask() { const payload = { title: document.getElementById('t-title').value, url: document.getElementById('t-url').value, fullPrice: document.getElementById('t-price').value, seconds: document.getElementById('t-sec').value }; await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_task', payload}) }); alert("ØªÙ…"); }
        async function addCoupon() { const payload = { code: document.getElementById('c-code').value, amount: document.getElementById('c-amnt').value, maxUses: document.getElementById('c-max').value }; await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'add_coupon', payload}) }); alert("ØªÙ…"); }
        async function proc(id, status) { if(!confirm("ØªØ£ÙƒÙŠØ¯ØŸ")) return; await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, action:'process_withdraw', payload:{id, status}}) }); loadData(); }
    </script>
</body>
</html>